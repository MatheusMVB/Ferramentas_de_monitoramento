import re
import matplotlib.pyplot as plt

def parse_tests(text):
    tests = []
    current = {}

    for line in text.splitlines():
        line = line.strip()

        # Detecta início de um teste
        m_label = re.match(r"^Teste\s+([\d\.]+)\%?$", line, re.IGNORECASE)
        if m_label:
            if current:
                tests.append(current)
            current = {"label": f"Teste {m_label.group(1)}%", "retrans": None, "netms": None}
            continue

        # Captura total de retransmissões
        m_retrans = re.search(r"Total de retransmissões TCP:\s*(\d+)", line, re.IGNORECASE)
        if m_retrans:
            current["retrans"] = int(m_retrans.group(1))
            continue

        # Captura tempo total de rede em segundos OU ms
        # Se seu arquivo tiver em segundos, convertemos para ms
        m_netsec = re.search(r"Tempo de Rede.*?:\s*([\d\.]+)\s*s", line, re.IGNORECASE)
        if m_netsec:
            current["netms"] = float(m_netsec.group(1)) * 1000
            continue

        m_netms = re.search(r"Tempo total de rede.*?:\s*([\d\.]+)\s*ms", line, re.IGNORECASE)
        if m_netms:
            current["netms"] = float(m_netms.group(1))
            continue

    if current:
        tests.append(current)

    # Filtra só os completos
    return [t for t in tests if t["retrans"] is not None and t["netms"] is not None]

# --- Ler o arquivo de resultados ---
with open("resultados.txt", "r", encoding="utf-8", errors="ignore") as f:
    text = f.read()

tests = parse_tests(text)
if not tests:
    print("⚠️ Nenhum teste válido encontrado!")
    exit()

labels = [t["label"] for t in tests]
retrans_vals = [t["retrans"] for t in tests]
network_ms = [t["netms"] for t in tests]

x = range(len(labels))
width = 0.4

fig, ax1 = plt.subplots()

# Primeira escala (retransmissões)
ax1.bar([p - width/2 for p in x], retrans_vals, width)
ax1.set_ylabel("Retransmissões")

# Segunda escala (tempo de rede em ms)
ax2 = ax1.twinx()
ax2.bar([p + width/2 for p in x], network_ms, width)
ax2.set_ylabel("Tempo de Rede (ms)")

ax1.set_xticks(x)
ax1.set_xticklabels(labels, rotation=30)
ax1.set_title("Retransmissões × Tempo total de rede (ms) por teste")

plt.tight_layout()
plt.show()

